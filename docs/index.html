<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Takes existing data and ensures proper feature and sample scaling along with matrix multiplication to project new data into the same space. Also provides ML tooling to transfer existing labels (e.g. Tissue or Cell Type) onto the new data.">
<title>Metadata projection via data morphing with matrix factorization multiplication â€¢ metamoRph</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Metadata projection via data morphing with matrix factorization multiplication">
<meta property="og:description" content="Takes existing data and ensures proper feature and sample scaling along with matrix multiplication to project new data into the same space. Also provides ML tooling to transfer existing labels (e.g. Tissue or Cell Type) onto the new data.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">metamoRph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/So_many_ways_to_screw_up_PCA_projection.html">So many ways to screw up PCA projection</a>
    <a class="dropdown-item" href="articles/real_data_testing.html">Metadata Label Transfer on Real Data</a>
    <a class="dropdown-item" href="articles/build_a_brain_region_predictor.html">Build and Apply a Human Brain Region Predictor in 60 seconds or less</a>
    <a class="dropdown-item" href="articles/morph_scRNA_query_onto_reference.html">Transfer Labels from a Retina scRNA Reference onto a Query Dataset</a>
    <a class="dropdown-item" href="articles/dataset_integration_and_projection.html">Batch Corrected metamoRph Reference</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="metamorph">metamoRph<a class="anchor" aria-label="anchor" href="#metamorph"></a>
</h1></div>
<p>A framework for projecting query (new) data onto an reference PCA space. This is easiest as a two step process where the user runs our <code>run_pca</code> function (which wraps <code>prcomp</code> and provides some sensible defaults and enhanced outputs. After <code>run_pca</code> the user can then use <code>metamoRph</code> to normalize the query (new) data in the same manner as the reference data and then project it onto the existing reference PCA.</p>
<p>We also provides two functions, <code>model_build</code> and <code>model_apply</code> to very quickly transfer metadata onto new data using the shared PCA space between the reference and the query.</p>
</div>
<div class="section level1">
<h1 id="quick-start">Quick Start<a class="anchor" aria-label="anchor" href="#quick-start"></a>
</h1>
<pre><code><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"davemcg/metamoRph"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davemcg.github.io/metamoRph/">metamoRph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'RHO'</span>,<span class="st">'RPE65'</span>,<span class="st">'ABCA4'</span>,<span class="st">'PMEL'</span>, <span class="st">'KRT5'</span><span class="op">)</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Retina1'</span>,<span class="st">'Retina2'</span>,<span class="st">'RPE1'</span>,<span class="st">'RPE2'</span>,<span class="st">'Cornea1'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">faux_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">560</span>,<span class="fl">650</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">0</span><span class="op">)</span>, <span class="co"># rho</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">42</span>,<span class="fl">32</span>, <span class="fl">1103</span>,<span class="fl">1201</span>,<span class="fl">2</span><span class="op">)</span>, <span class="co">#rpe65</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">810</span>,<span class="fl">903</span>,<span class="fl">202</span>,<span class="fl">205</span>,<span class="fl">45</span><span class="op">)</span>,  <span class="co">#abca4</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>,<span class="fl">105</span>,<span class="fl">2004</span>,<span class="fl">1980</span>,<span class="fl">101</span><span class="op">)</span>,<span class="co"># pmel</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">32</span>,<span class="fl">101</span>,<span class="fl">202</span>,<span class="fl">1567</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="co"># krt5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">faux_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">faux_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">samples</span></span>
<span></span>
<span><span class="va">new_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">3</span><span class="op">)</span>, <span class="co"># rho</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">32</span>,<span class="fl">23</span>,<span class="fl">54</span><span class="op">)</span>, <span class="co">#rpe65</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">65</span>,<span class="fl">22</span>,<span class="fl">10</span><span class="op">)</span>,  <span class="co">#abca4</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">122</span>,<span class="fl">101</span>,<span class="fl">57</span><span class="op">)</span>,<span class="co"># pmel</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2567</span>,<span class="fl">1755</span>,<span class="fl">2218</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span> <span class="co"># krt5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">genes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cornea2"</span>,<span class="st">"Cornea3"</span>,<span class="st">"Cornea4"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mm_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/run_pca.html">run_pca</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">faux_mat</span><span class="op">)</span>, meta <span class="op">=</span> <span class="va">samples</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">projected_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span>, </span>
<span>                               <span class="va">mm_pca</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>, </span>
<span>                               center_scale <span class="op">=</span> <span class="va">mm_pca</span><span class="op">$</span><span class="va">center_scale</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># example plot</span></span>
<span><span class="co"># bind_rows(as_tibble(mm_pca$PCA$x, rownames = 'samples'),</span></span>
<span><span class="co">#       as_tibble(projected_pca, rownames = 'Cornea')) |&gt;</span></span>
<span><span class="co">#   mutate(samples = gsub('\\d','',samples)) |&gt;</span></span>
<span><span class="co">#   ggplot(aes(x=PC1,y=PC2,color=samples)) + </span></span>
<span><span class="co">#   geom_point() +</span></span>
<span><span class="co">#   cowplot::theme_cowplot()</span></span></code></pre>
<div class="section level2">
<h2 id="label-projection">Label projection<a class="anchor" aria-label="anchor" href="#label-projection"></a>
</h2>
<pre><code><span><span class="co"># continue from code chunk above</span></span>
<span><span class="co">## WARNING: Use many more num_PCs (20+) for "real" genomic data</span></span>
<span><span class="va">trained_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/model_build.html">model_build</a></span><span class="op">(</span><span class="va">mm_pca</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">'\\d+'</span>,<span class="st">''</span>, <span class="va">mm_pca</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">samples</span><span class="op">)</span>, <span class="co">#remove trailing digit </span></span>
<span>                             model <span class="op">=</span> <span class="st">'lm'</span>, num_PCs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">label_guesses</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">trained_model</span>,</span>
<span>                             <span class="va">projected_pca</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cornea"</span>,<span class="st">"Cornea"</span>,<span class="st">"Cornea"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># label_guesses</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="existing-prcomp-object-projection-example-pseudocode-ish">Existing prcomp object projection example (pseudocode-ish)<a class="anchor" aria-label="anchor" href="#existing-prcomp-object-projection-example-pseudocode-ish"></a>
</h2>
<p>It is also possible to use a pre-existing prcomp object with <code>metamoRph</code>, skipping the <code>run_pca</code> step. You will have to ensure that you sample scale your <code>new_data</code> in the same manner that you used for your <code>prcomp</code> run (here we use <code>log2</code> - but replace with whatever scaling your have done. Maybe none?). Note how we have turned off the cpm and log1p scaling in the <code>metamoRph</code> function with <code>normaliztion = FALSE</code>.</p>
<pre><code><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davemcg.github.io/metamoRph/">metamoRph</a></span><span class="op">)</span></span>
<span><span class="va">projected_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                               <span class="va">your_prcomp_object</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>, </span>
<span>                               center_scale <span class="op">=</span> <span class="fu"><a href="reference/extract_prcomp_scaling.html">extract_prcomp_scaling</a></span><span class="op">(</span><span class="va">your_prcomp_object</span><span class="op">)</span>,</span>
<span>                               normalization <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level1">
<h1 id="some-related-tools">Some Related Tools<a class="anchor" aria-label="anchor" href="#some-related-tools"></a>
</h1>
<ul>
<li>(ProjecTILs)[<a href="https://github.com/carmonalab/ProjecTILs" class="external-link uri">https://github.com/carmonalab/ProjecTILs</a>]
<ul>
<li>scRNA/Seurat based tool that uses a similar approach to project data (essentialy multiplying the new against the rotation matrix)</li>
</ul>
</li>
<li>(Seurat)[<a href="https://satijalab.org/seurat/articles/integration_mapping.html" class="external-link uri">https://satijalab.org/seurat/articles/integration_mapping.html</a>]
<ul>
<li>The big kahuna itself. scRNA analysis playground.</li>
</ul>
</li>
<li>(projectR)[<a href="https://www.bioconductor.org/packages/release/bioc/html/projectR.html" class="external-link uri">https://www.bioconductor.org/packages/release/bioc/html/projectR.html</a>]
<ul>
<li>Can transfer data onto PCA <em>and</em> NMF</li>
<li>At least for PCA does not provide any guardrails for properly scaling the query data</li>
</ul>
</li>
</ul>
</div>

  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE-text.html">LICENSE</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing metamoRph</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>David McGaughey <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-9224-2888" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David McGaughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
