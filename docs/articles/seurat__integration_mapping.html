<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metamoRph">
<title>Mapping and annotating query datasets • metamoRph</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mapping and annotating query datasets">
<meta property="og:description" content="metamoRph">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">metamoRph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/So_many_ways_to_screw_up_PCA_projection.html">So many ways to screw up PCA projection</a>
    <a class="dropdown-item" href="../articles/build_a_brain_region_predictor.html">Build and Apply a Human Brain Region Predictor in 60 seconds or less</a>
    <a class="dropdown-item" href="../articles/dataset_integration_and_projection.html">Batch Corrected metamoRph Reference</a>
    <a class="dropdown-item" href="../articles/real_data_testing.html">Metadata Label Transfer on Real Data</a>
    <a class="dropdown-item" href="../articles/seurat__integration_mapping.html">Mapping and annotating query datasets</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Mapping and annotating query datasets</h1>
            
            <h4 data-toc-skip class="date">Compiled: 2023-07-24</h4>
      
      
      <div class="d-none name"><code>seurat__integration_mapping.Rmd</code></div>
    </div>

    
    
<hr>
<div class="section level2">
<h2 id="introduction-to-single-cell-reference-mapping">Introduction to single-cell reference mapping<a class="anchor" aria-label="anchor" href="#introduction-to-single-cell-reference-mapping"></a>
</h2>
<p>In this vignette, we first build an integrated reference and then
demonstrate how to leverage this reference to annotate new query
datasets. Generating an integrated reference follows the same workflow
described in more detail in the integration introduction <a href="integration_introduction.html">vignette</a>. Once generated, this
reference can be used to analyze additional query datasets through tasks
like cell type label transfer and projecting query cells onto reference
UMAPs. Notably, this does not require correction of the underlying raw
query data and can therefore be an efficient strategy if a high quality
reference is available.</p>
</div>
<div class="section level2">
<h2 id="dataset-preprocessing">Dataset preprocessing<a class="anchor" aria-label="anchor" href="#dataset-preprocessing"></a>
</h2>
<p>For the purposes of this example, we’ve chosen human pancreatic islet
cell datasets produced across four technologies, CelSeq (GSE81076)
CelSeq2 (GSE85241), Fluidigm C1 (GSE86469), and SMART-Seq2
(E-MTAB-5061). For convenience, we distribute this dataset through our
<a href="https://github.com/satijalab/seurat-data" class="external-link">SeuratData</a>
package. The metadata contains the technology (<code>tech</code> column)
and cell type annotations (<code>celltype</code> column) for each cell
in the four datasets.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.satijalab.org/seurat" class="external-link">SeuratData</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/InstallData.html" class="external-link">InstallData</a></span><span class="op">(</span><span class="st">"panc8"</span><span class="op">)</span></span></code></pre></div>
<p>To construct a reference, we will identify ‘anchors’ between the
individual datasets. First, we split the combined object into a list,
with each dataset as an element (this is only necessary because the data
was bundled together for easy distribution).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"panc8"</span><span class="op">)</span></span>
<span><span class="va">pancreas.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SplitObject.html" class="external-link">SplitObject</a></span><span class="op">(</span><span class="va">panc8</span>, split.by <span class="op">=</span> <span class="st">"tech"</span><span class="op">)</span></span>
<span><span class="va">pancreas.list</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"celseq"</span>, <span class="st">"celseq2"</span>, <span class="st">"fluidigmc1"</span>, <span class="st">"smartseq2"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Prior to finding anchors, we perform standard preprocessing
(log-normalization), and identify variable features individually for
each. Note that Seurat implements an improved method for variable
feature selection based on a variance stabilizing transformation
(<code>"vst"</code>)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, selection.method <span class="op">=</span> <span class="st">"vst"</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>        verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="integration-of-3-pancreatic-islet-cell-datasets">Integration of 3 pancreatic islet cell datasets<a class="anchor" aria-label="anchor" href="#integration-of-3-pancreatic-islet-cell-datasets"></a>
</h2>
<p>Next, we identify anchors using the
<code><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html" class="external-link">FindIntegrationAnchors()</a></code> function, which takes a list of
Seurat objects as input. Here, we integrate three of the objects into a
reference (we will use the fourth later in this vignette as a query
dataset to demonstrate mapping).</p>
<ul>
<li>We use all default parameters here for identifying anchors,
including the ‘dimensionality’ of the dataset (30; feel free to try
varying this parameter over a broad range, for example between 10 and
50).</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reference.list</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"celseq"</span>, <span class="st">"celseq2"</span>, <span class="st">"smartseq2"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pancreas.anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html" class="external-link">FindIntegrationAnchors</a></span><span class="op">(</span>object.list <span class="op">=</span> <span class="va">reference.list</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>We then pass these anchors to the <code><a href="https://satijalab.org/seurat/reference/IntegrateData.html" class="external-link">IntegrateData()</a></code>
function, which returns a Seurat object.</p>
<ul>
<li>The returned object will contain a new <code>Assay</code>, which
holds an integrated (or ‘batch-corrected’) expression matrix for all
cells, enabling them to be jointly analyzed.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/IntegrateData.html" class="external-link">IntegrateData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>After running <code><a href="https://satijalab.org/seurat/reference/IntegrateData.html" class="external-link">IntegrateData()</a></code>, the <code>Seurat</code>
object will contain a new <code>Assay</code> with the integrated
expression matrix. Note that the original (uncorrected values) are still
stored in the object in the “RNA” assay, so you can switch back and
forth.</p>
<p>We can then use this new integrated matrix for downstream analysis
and visualization. Here we scale the integrated data, run PCA, and
visualize the results with UMAP. The integrated datasets cluster by cell
type, instead of by technology.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="co"># switch to integrated assay. The variable features of this assay are automatically set during</span></span>
<span><span class="co"># IntegrateData</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">pancreas.integrated</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"integrated"</span></span>
<span><span class="co"># Run the standard workflow for visualization and clustering</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, npcs <span class="op">=</span> <span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"tech"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"celltype"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="seurat__integration_mapping_files/figure-html/analysis-1.png" width="960"></p>
</div>
<div class="section level2">
<h2 id="cell-type-classification-using-an-integrated-reference">Cell type classification using an integrated reference<a class="anchor" aria-label="anchor" href="#cell-type-classification-using-an-integrated-reference"></a>
</h2>
<p>Seurat also supports the projection of reference data (or meta data)
onto a query object. While many of the methods are conserved (both
procedures begin by identifying anchors), there are two important
distinctions between data transfer and integration:</p>
<ol style="list-style-type: decimal">
<li>In data transfer, Seurat does not correct or modify the query
expression data.</li>
<li>In data transfer, Seurat has an option (set by default) to project
the PCA structure of a reference onto the query, instead of learning a
joint structure with CCA. We generally suggest using this option when
projecting data between scRNA-seq datasets.</li>
</ol>
<p>After finding anchors, we use the <code><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData()</a></code>
function to classify the query cells based on reference data (a vector
of reference cell type labels). <code><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData()</a></code> returns a
matrix with predicted IDs and prediction scores, which we can add to the
query metadata.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[[</span><span class="st">"fluidigmc1"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pancreas.anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindTransferAnchors.html" class="external-link">FindTransferAnchors</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">pancreas.integrated</span>, query <span class="op">=</span> <span class="va">pancreas.query</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, reference.reduction <span class="op">=</span> <span class="st">"pca"</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, refdata <span class="op">=</span> <span class="va">pancreas.integrated</span><span class="op">$</span><span class="va">celltype</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AddMetaData.html" class="external-link">AddMetaData</a></span><span class="op">(</span><span class="va">pancreas.query</span>, metadata <span class="op">=</span> <span class="va">predictions</span><span class="op">)</span></span></code></pre></div>
<p>Because we have the original label annotations from our full
integrated analysis, we can evaluate how well our predicted cell type
annotations match the full reference. In this example, we find that
there is a high agreement in cell type classification, with over 96% of
cells being labeled correctly.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span> <span class="op">&lt;-</span> <span class="va">pancreas.query</span><span class="op">$</span><span class="va">predicted.id</span> <span class="op">==</span> <span class="va">pancreas.query</span><span class="op">$</span><span class="va">celltype</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## FALSE  TRUE </span></span>
<span><span class="co">##    21   617</span></span></code></pre>
<p>To verify this further, we can examine some canonical cell type
markers for specific pancreatic islet cell populations. Note that even
though some of these cell types are only represented by one or two cells
(e.g. epsilon cells), we are still able to classify them correctly.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">predicted.id</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##             acinar activated_stellate              alpha               beta </span></span>
<span><span class="co">##                 22                 17                253                256 </span></span>
<span><span class="co">##              delta             ductal        endothelial              gamma </span></span>
<span><span class="co">##                 22                 30                 12                 18 </span></span>
<span><span class="co">##         macrophage               mast            schwann </span></span>
<span><span class="co">##                  1                  2                  5</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html" class="external-link">VlnPlot</a></span><span class="op">(</span><span class="va">pancreas.query</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"REG1A"</span>, <span class="st">"PPY"</span>, <span class="st">"SST"</span>, <span class="st">"GHRL"</span>, <span class="st">"VWF"</span>, <span class="st">"SOX10"</span><span class="op">)</span>, group.by <span class="op">=</span> <span class="st">"predicted.id"</span><span class="op">)</span></span></code></pre></div>
<p><img src="seurat__integration_mapping_files/figure-html/vlnplots-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="unimodal-umap-projection">Unimodal UMAP Projection<a class="anchor" aria-label="anchor" href="#unimodal-umap-projection"></a>
</h2>
<p>In Seurat v4, we also enable projection of a query onto the reference
UMAP structure. This can be achieved by computing the reference UMAP
model and then calling <code><a href="https://satijalab.org/seurat/reference/MapQuery.html" class="external-link">MapQuery()</a></code> instead of
<code><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, return.model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/MapQuery.html" class="external-link">MapQuery</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, reference <span class="op">=</span> <span class="va">pancreas.integrated</span>, query <span class="op">=</span> <span class="va">pancreas.query</span>,</span>
<span>    refdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>celltype <span class="op">=</span> <span class="st">"celltype"</span><span class="op">)</span>, reference.reduction <span class="op">=</span> <span class="st">"pca"</span>, reduction.model <span class="op">=</span> <span class="st">"umap"</span><span class="op">)</span></span></code></pre></div>
<details><summary><strong>What is <code>MapQuery</code> doing?</strong>
</summary><p><code><a href="https://satijalab.org/seurat/reference/MapQuery.html" class="external-link">MapQuery()</a></code> is a wrapper around three functions:
<code><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData()</a></code>, <code><a href="https://satijalab.org/seurat/reference/IntegrateEmbeddings.html" class="external-link">IntegrateEmbeddings()</a></code>, and
<code><a href="https://satijalab.org/seurat/reference/ProjectUMAP.html" class="external-link">ProjectUMAP()</a></code>. <code><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData()</a></code> is used to
transfer cell type labels and impute the ADT values;
<code><a href="https://satijalab.org/seurat/reference/IntegrateEmbeddings.html" class="external-link">IntegrateEmbeddings()</a></code> is used to integrate reference with
query by correcting the query’s projected low-dimensional embeddings;
and finally <code><a href="https://satijalab.org/seurat/reference/ProjectUMAP.html" class="external-link">ProjectUMAP()</a></code> is used to project the query data
onto the UMAP structure of the reference. The equivalent code for doing
this with the intermediate functions is below:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, reference <span class="op">=</span> <span class="va">pancreas.integrated</span>, query <span class="op">=</span> <span class="va">pancreas.query</span>,</span>
<span>    refdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>celltype <span class="op">=</span> <span class="st">"celltype"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/IntegrateEmbeddings.html" class="external-link">IntegrateEmbeddings</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, reference <span class="op">=</span> <span class="va">pancreas.integrated</span>,</span>
<span>    query <span class="op">=</span> <span class="va">pancreas.query</span>, new.reduction.name <span class="op">=</span> <span class="st">"ref.pca"</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ProjectUMAP.html" class="external-link">ProjectUMAP</a></span><span class="op">(</span>query <span class="op">=</span> <span class="va">pancreas.query</span>, query.reduction <span class="op">=</span> <span class="st">"ref.pca"</span>, reference <span class="op">=</span> <span class="va">pancreas.integrated</span>,</span>
<span>    reference.reduction <span class="op">=</span> <span class="st">"pca"</span>, reduction.model <span class="op">=</span> <span class="st">"umap"</span><span class="op">)</span></span></code></pre></div>
</details><p>We can now visualize the query cells alongside our reference.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"celltype"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, label.size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Reference annotations"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.query</span>, reduction <span class="op">=</span> <span class="st">"ref.umap"</span>, group.by <span class="op">=</span> <span class="st">"predicted.celltype"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    label.size <span class="op">=</span> <span class="fl">3</span>, repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Query transferred labels"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="seurat__integration_mapping_files/figure-html/panc.refdimplots-1.png" width="960"></p>
<details><summary><strong>Session Info</strong>
</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Ventura 13.4.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] patchwork_1.1.2        cowplot_1.1.1          ggplot2_3.4.2         </span></span>
<span><span class="co">## [4] panc8.SeuratData_3.0.2 SeuratData_0.2.2       SeuratObject_4.1.3    </span></span>
<span><span class="co">## [7] Seurat_4.3.0.1        </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RColorBrewer_1.1-3     rstudioapi_0.14        jsonlite_1.8.4        </span></span>
<span><span class="co">##   [4] magrittr_2.0.3         ggbeeswarm_0.7.2       spatstat.utils_3.0-3  </span></span>
<span><span class="co">##   [7] farver_2.1.1           rmarkdown_2.21         fs_1.6.2              </span></span>
<span><span class="co">##  [10] ragg_1.2.5             vctrs_0.6.2            ROCR_1.0-11           </span></span>
<span><span class="co">##  [13] memoise_2.0.1          spatstat.explore_3.2-1 htmltools_0.5.5       </span></span>
<span><span class="co">##  [16] sass_0.4.6             sctransform_0.3.5      parallelly_1.36.0     </span></span>
<span><span class="co">##  [19] KernSmooth_2.23-21     bslib_0.5.0            htmlwidgets_1.6.2     </span></span>
<span><span class="co">##  [22] desc_1.4.2             ica_1.0-3              plyr_1.8.8            </span></span>
<span><span class="co">##  [25] plotly_4.10.1          zoo_1.8-12             cachem_1.0.8          </span></span>
<span><span class="co">##  [28] igraph_1.4.3           mime_0.12              lifecycle_1.0.3       </span></span>
<span><span class="co">##  [31] pkgconfig_2.0.3        Matrix_1.5-4.1         R6_2.5.1              </span></span>
<span><span class="co">##  [34] fastmap_1.1.1          fitdistrplus_1.1-11    future_1.32.0         </span></span>
<span><span class="co">##  [37] shiny_1.7.4            digest_0.6.31          colorspace_2.1-0      </span></span>
<span><span class="co">##  [40] rprojroot_2.0.3        tensor_1.5             irlba_2.3.5.1         </span></span>
<span><span class="co">##  [43] textshaping_0.3.6      labeling_0.4.2         progressr_0.13.0      </span></span>
<span><span class="co">##  [46] fansi_1.0.4            spatstat.sparse_3.0-2  httr_1.4.6            </span></span>
<span><span class="co">##  [49] polyclip_1.10-4        abind_1.4-5            compiler_4.3.0        </span></span>
<span><span class="co">##  [52] withr_2.5.0            highr_0.10             MASS_7.3-60           </span></span>
<span><span class="co">##  [55] rappdirs_0.3.3         tools_4.3.0            vipor_0.4.5           </span></span>
<span><span class="co">##  [58] lmtest_0.9-40          beeswarm_0.4.0         httpuv_1.6.11         </span></span>
<span><span class="co">##  [61] future.apply_1.11.0    goftest_1.2-3          glue_1.6.2            </span></span>
<span><span class="co">##  [64] nlme_3.1-162           promises_1.2.0.1       grid_4.3.0            </span></span>
<span><span class="co">##  [67] Rtsne_0.16             cluster_2.1.4          reshape2_1.4.4        </span></span>
<span><span class="co">##  [70] generics_0.1.3         gtable_0.3.3           spatstat.data_3.0-1   </span></span>
<span><span class="co">##  [73] tidyr_1.3.0            data.table_1.14.8      sp_2.0-0              </span></span>
<span><span class="co">##  [76] utf8_1.2.3             spatstat.geom_3.2-2    RcppAnnoy_0.0.20      </span></span>
<span><span class="co">##  [79] ggrepel_0.9.3          RANN_2.6.1             pillar_1.9.0          </span></span>
<span><span class="co">##  [82] stringr_1.5.0          later_1.3.1            splines_4.3.0         </span></span>
<span><span class="co">##  [85] dplyr_1.1.2            lattice_0.21-8         survival_3.5-5        </span></span>
<span><span class="co">##  [88] deldir_1.0-9           tidyselect_1.2.0       miniUI_0.1.1.1        </span></span>
<span><span class="co">##  [91] pbapply_1.7-2          knitr_1.43             gridExtra_2.3         </span></span>
<span><span class="co">##  [94] scattermore_1.1        xfun_0.39              matrixStats_0.63.0    </span></span>
<span><span class="co">##  [97] stringi_1.7.12         lazyeval_0.2.2         yaml_2.3.7            </span></span>
<span><span class="co">## [100] evaluate_0.21          codetools_0.2-19       tibble_3.2.1          </span></span>
<span><span class="co">## [103] cli_3.6.1              uwot_0.1.14            xtable_1.8-4          </span></span>
<span><span class="co">## [106] reticulate_1.28        systemfonts_1.0.4      munsell_0.5.0         </span></span>
<span><span class="co">## [109] jquerylib_0.1.4        Rcpp_1.0.10            globals_0.16.2        </span></span>
<span><span class="co">## [112] spatstat.random_3.1-5  png_0.1-8              ggrastr_1.0.1         </span></span>
<span><span class="co">## [115] parallel_4.3.0         ellipsis_0.3.2         pkgdown_2.0.7         </span></span>
<span><span class="co">## [118] listenv_0.9.0          viridisLite_0.4.2      scales_1.2.1          </span></span>
<span><span class="co">## [121] ggridges_0.5.4         leiden_0.4.3           purrr_1.0.1           </span></span>
<span><span class="co">## [124] crayon_1.5.2           rlang_1.1.1            formatR_1.14</span></span></code></pre>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David McGaughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
