<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metamoRph">
<title>Batch Corrected metamoRph Reference • metamoRph</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Batch Corrected metamoRph Reference">
<meta property="og:description" content="metamoRph">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">metamoRph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/So_many_ways_to_screw_up_PCA_projection.html">So many ways to screw up PCA projection</a>
    <a class="dropdown-item" href="../articles/real_data_testing.html">Metadata Label Transfer on Real Data</a>
    <a class="dropdown-item" href="../articles/build_a_brain_region_predictor.html">Build and Apply a Human Brain Region Predictor in 60 seconds or less</a>
    <a class="dropdown-item" href="../articles/morph_scRNA_query_onto_reference.html">Transfer Labels from a Retina scRNA Reference onto a Query Dataset</a>
    <a class="dropdown-item" href="../articles/dataset_integration_and_projection.html">Batch Corrected metamoRph Reference</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Batch Corrected metamoRph Reference</h1>
            
            <h4 data-toc-skip class="date">2023-07-25</h4>
      
      
      <div class="d-none name"><code>dataset_integration_and_projection.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>You want to build a <em>batch corrected</em> scRNA-seq reference from
several disparate datasets to use as a resource for label transfer and
visualization onto <em>new</em> data.</p>
</div>
<div class="section level2">
<h2 id="so">So…<a class="anchor" aria-label="anchor" href="#so"></a>
</h2>
<p>metamoRph <strong>is not</strong> a batch correction tool. Just a
small set of functions to enable projection of data onto an existing
reference resource.</p>
<p>Using a disparate set of scRNA datasets with
<code><a href="../reference/run_pca.html">metamoRph::run_pca</a></code> requires those datasets to be batch
corrected.</p>
<p>Here we present two approaches: one using Seurat’s
<code>IntegrateData</code> and another with scMerge2 to generate
corrected counts.</p>
<p>To demonstrate that the applicability of metamoRph can extend beyond
data I am cherry picking from the variety of ocular resources I have
curated, we will use the data from Seurat’s <a href="https://satijalab.org/seurat/articles/integration_mapping.html" class="external-link">Mapping
and annotating query datasets</a> guide.</p>
</div>
<div class="section level2">
<h2 id="why-not-just-use-seurat-the-whole-way-through">Why not just use Seurat the whole way through?????<a class="anchor" aria-label="anchor" href="#why-not-just-use-seurat-the-whole-way-through"></a>
</h2>
<p>Seurat has a very full set of tools to do just about everything -
including the batch correction, projecting new data onto it, and then
transfer the labels and make a matching UMAP. The code that does that is
reproduced in the first code chunk.</p>
<p>Why even bother using metamoRph? There are two reasons. First, is
that metamoRph is a <em>general</em> projection engine. You can use it
for bulk RNA. You can use it for scRNA. There is no reason why you can’t
use it for other kinds of information! PCA (or SVD) are tremendous
dimensionality reduction approaches and I find it amazing that, with a
touch of attention about data preprocessing, you can project (morph!)
new data onto an existing PCA space with just a matrix multiplication.
The second is speed. Because our approach is so simple, once you have
built a reference, you can morph new data <em>and</em> do the label
transfer in second(s).</p>
</div>
<div class="section level2">
<h2 id="why-cant-i-use-the-pca-i-already-made-with-seurat">Why can’t I use the PCA I already made with Seurat?<a class="anchor" aria-label="anchor" href="#why-cant-i-use-the-pca-i-already-made-with-seurat"></a>
</h2>
<p>Unfortunately you can’t use the Seurat PCA because they do not return
the center and scaling values used in their internal data normalization.
The bog standard <code>prcomp</code> function <em>does</em> return these
values, so if the PCA you are using is from <code>prcomp</code> (or
inspired by <code>prcomp</code>) then those values can be extracted from
the returned object with
<code><a href="../reference/extract_prcomp_scaling.html">metamoRph::extract_prcomp_scaling()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="package-loads">Package Loads<a class="anchor" aria-label="anchor" href="#package-loads"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.satijalab.org/seurat" class="external-link">SeuratData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jlmelville/uwot" class="external-link">uwot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davemcg.github.io/metamoRph/">metamoRph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/SydneyBioX/scMerge" class="external-link">scMerge</a></span><span class="op">)</span></span>
<span><span class="co"># InstallData('panc8')</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="seurat-dataset-integration">Seurat Dataset Integration<a class="anchor" aria-label="anchor" href="#seurat-dataset-integration"></a>
</h2>
<p>This code is taken from the Seurat v4 <a href="https://satijalab.org/seurat/articles/integration_mapping.html" class="external-link">Mapping
and annotating query datasets</a> guide. The git link to the guide is <a href="https://github.com/satijalab/seurat/blob/78c2c94dbd9fdb7e3facbacee7f34900d8f20ff1/vignettes/integration_mapping.Rmd" class="external-link">here</a>,
should the previous link go dead or the guide is substantially changed
in the future.</p>
<div class="section level3">
<h3 id="integrate">Integrate<a class="anchor" aria-label="anchor" href="#integrate"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"panc8"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pancreas.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SplitObject.html" class="external-link">SplitObject</a></span><span class="op">(</span><span class="va">panc8</span>, split.by <span class="op">=</span> <span class="st">"tech"</span><span class="op">)</span></span>
<span><span class="va">pancreas.list</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"celseq"</span>, <span class="st">"celseq2"</span>, <span class="st">"fluidigmc1"</span>, <span class="st">"smartseq2"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, selection.method <span class="op">=</span> <span class="st">"vst"</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>        verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="va">reference.list</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"celseq"</span>, <span class="st">"celseq2"</span>, <span class="st">"smartseq2"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">pancreas.anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html" class="external-link">FindIntegrationAnchors</a></span><span class="op">(</span>object.list <span class="op">=</span> <span class="va">reference.list</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/IntegrateData.html" class="external-link">IntegrateData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">seurat_integration_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="map-new-data-onto-reference">Map New Data Onto Reference<a class="anchor" aria-label="anchor" href="#map-new-data-onto-reference"></a>
</h3>
<p>Seurat’s approach results in 617 correct labels and 21 incorrect.
Given the UMAP viz (cue Lior Pachter screaming) probably a few of those
“incorrect” are mislabels.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># switch to integrated assay. The variable features of this assay are automatically set during</span></span>
<span><span class="co"># IntegrateData</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">pancreas.integrated</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"integrated"</span></span>
<span><span class="co"># Run the standard workflow for visualization and clustering</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, npcs <span class="op">=</span> <span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">seurat_rebuild_analysis_on_corrected_data_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 11.342 sec elapsed</span></span>
<span><span class="co"># p1 &lt;- DimPlot(pancreas.integrated, reduction = 'umap', group.by = 'tech') p2 &lt;-</span></span>
<span><span class="co"># DimPlot(pancreas.integrated, reduction = 'umap', group.by = 'celltype', label = TRUE, repel</span></span>
<span><span class="co"># = TRUE) + NoLegend() p1 + p2</span></span>
<span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># project new data onto reference and build matching umap</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="va">pancreas.list</span><span class="op">[[</span><span class="st">"fluidigmc1"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pancreas.anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindTransferAnchors.html" class="external-link">FindTransferAnchors</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">pancreas.integrated</span>, query <span class="op">=</span> <span class="va">pancreas.query</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, reference.reduction <span class="op">=</span> <span class="st">"pca"</span><span class="op">)</span></span>
<span><span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/TransferData.html" class="external-link">TransferData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, refdata <span class="op">=</span> <span class="va">pancreas.integrated</span><span class="op">$</span><span class="va">celltype</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/AddMetaData.html" class="external-link">AddMetaData</a></span><span class="op">(</span><span class="va">pancreas.query</span>, metadata <span class="op">=</span> <span class="va">predictions</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pancreas.integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, return.model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pancreas.query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/MapQuery.html" class="external-link">MapQuery</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">pancreas.anchors</span>, reference <span class="op">=</span> <span class="va">pancreas.integrated</span>, query <span class="op">=</span> <span class="va">pancreas.query</span>,</span>
<span>    refdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>celltype <span class="op">=</span> <span class="st">"celltype"</span><span class="op">)</span>, reference.reduction <span class="op">=</span> <span class="st">"pca"</span>, reduction.model <span class="op">=</span> <span class="st">"umap"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span> <span class="op">&lt;-</span> <span class="va">pancreas.query</span><span class="op">$</span><span class="va">predicted.id</span> <span class="op">==</span> <span class="va">pancreas.query</span><span class="op">$</span><span class="va">celltype</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; FALSE  TRUE </span></span>
<span><span class="co">#&gt;    21   617</span></span>
<span><span class="va">seurat_default_accuracy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">$</span><span class="va">prediction.match</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># end timing BEFOFE the plotting step so we don't also compare plotting efficiency</span></span>
<span><span class="va">seurat_projection_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 15.439 sec elapsed</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.integrated</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"celltype"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, label.size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Reference annotations"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">pancreas.query</span>, reduction <span class="op">=</span> <span class="st">"ref.umap"</span>, group.by <span class="op">=</span> <span class="st">"predicted.celltype"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    label.size <span class="op">=</span> <span class="fl">3</span>, repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Query transferred labels"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<div class="float">
<img src="figure/seurat%20example%20umaps-1.png" alt="plot of chunk seurat example umaps"><div class="figcaption">plot of chunk seurat example umaps</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="leverage-seurats-corrected-counts-in-metamorph">Leverage Seurat’s Corrected Counts in metamoRph<a class="anchor" aria-label="anchor" href="#leverage-seurats-corrected-counts-in-metamorph"></a>
</h2>
<p>The first approach we demonstrate is to directly use Seurat’s
corrected counts from the code chunk above in building a “metamoRph”
reference and then projecting/morphing the new data onto it. Read the
commented lines in the code block to see explanations of why certain
parameters were used in metamoRph.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># here we pull the corrected counts from the `integrated` slot and use it as the reference</span></span>
<span><span class="co"># data NOTE 1: see how we have TURNED OFF NORMALIZATION as the data already is normalized NOTE</span></span>
<span><span class="co"># 2: we have changed ntop from the default of 1000 to 2000 to match what Seurat uses in their</span></span>
<span><span class="co"># example</span></span>
<span><span class="va">reference_obj</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/run_pca.html">run_pca</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pancreas.integrated</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">integrated</span><span class="op">@</span><span class="va">data</span><span class="op">)</span>, meta <span class="op">=</span> <span class="va">pancreas.integrated</span><span class="op">@</span><span class="va">meta.data</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"irlba"</span>, normalization <span class="op">=</span> <span class="cn">FALSE</span>, irlba_n <span class="op">=</span> <span class="fl">30</span>, ntop <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co"># Seurat and scran both use cosine instead of euclidean as the metric see also how we have the</span></span>
<span><span class="co"># full umap model returned this is required downstream</span></span>
<span><span class="va">ref_umap</span> <span class="op">&lt;-</span> <span class="fu">uwot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, metric <span class="op">=</span> <span class="st">"cosine"</span>, ret_model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">metamoRph_build_ref_from_seurat_counts</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 8.896 sec elapsed</span></span>
<span></span>
<span><span class="co"># plotting code first we are going to stick some of the first lines into a little function to</span></span>
<span><span class="co"># reduce copy/pasting for the later plots</span></span>
<span></span>
<span><span class="va">quick_plotter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">umap_data</span>, <span class="va">matching_metadata</span>, <span class="va">point_color</span> <span class="op">=</span> <span class="st">"celltype"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">matching_metadata</span><span class="op">$</span><span class="va">group</span> <span class="op">&lt;-</span> <span class="va">matching_metadata</span><span class="op">[</span>, <span class="va">point_color</span><span class="op">]</span></span>
<span>    <span class="va">umap_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"bc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">matching_metadata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>            <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"bc"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">V1</span>, y <span class="op">=</span> <span class="va">V2</span>, color <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>V1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span>, V2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">V2</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">group</span>, color <span class="op">=</span> <span class="va">group</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>        bg.color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">glasbey</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">quick_plotter</span><span class="op">(</span><span class="va">ref_umap</span><span class="op">$</span><span class="va">embedding</span>, <span class="va">pancreas.integrated</span><span class="op">@</span><span class="va">meta.data</span>, <span class="st">"celltype"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Reference: celseq, celseq2, smartseq2"</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># here is where we take the new/query data `pancreas.query` and yank out the raw counts we</span></span>
<span><span class="co"># specify that metamoRph should transform the counts data using the 'Seurat' approach instead</span></span>
<span><span class="co"># of the default 'cpm' approach</span></span>
<span><span class="va">query_morphed</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span><span class="op">)</span>, <span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,</span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, center_scale <span class="op">=</span> <span class="va">reference_obj</span><span class="op">$</span><span class="va">center_scale</span>, sample_scale <span class="op">=</span> <span class="st">"seurat"</span><span class="op">)</span></span>
<span><span class="co"># now we use the reference data PCA ($PCA$x slot) in our model builder to build a cell type</span></span>
<span><span class="co"># label guesser from the known labels 'reference_obj$meta$celltype'</span></span>
<span><span class="va">ml</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/model_build.html">model_build</a></span><span class="op">(</span><span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, <span class="va">reference_obj</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span></span>
<span><span class="co"># now we use the models we built to apply to the new data's metamoRph projected PCA space</span></span>
<span><span class="va">ma</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">ml</span>, <span class="va">query_morphed</span>, <span class="va">pancreas.query</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seurat_metamorph_accuracy</span> <span class="op">&lt;-</span> <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sample_label</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Accuracy:"</span>, <span class="va">seurat_metamorph_accuracy</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Accuracy: 0.946708463949843"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"# Correct:"</span>, <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "# Correct: 604"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"# Wrong:"</span>, <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">!=</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "# Wrong: 34"</span></span>
<span></span>
<span></span>
<span><span class="va">umap_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap_transform.html" class="external-link">umap_transform</a></span><span class="op">(</span><span class="va">query_morphed</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, <span class="va">ref_umap</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seurat_metamorph_project_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0.739 sec elapsed</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">quick_plotter</span><span class="op">(</span><span class="va">umap_proj</span>, <span class="va">pancreas.query</span><span class="op">@</span><span class="va">meta.data</span>, <span class="st">"celltype"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Query: fluidigmc1"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/seurat_metamoRph_collab-1.png" alt="plot of chunk seurat_metamoRph_collab"><div class="figcaption">plot of chunk seurat_metamoRph_collab</div>
</div>
</div>
<div class="section level2">
<h2 id="scmerge2-batch-correction-as-input-to-metamorph">scMerge2 Batch Correction as Input to metamoRph<a class="anchor" aria-label="anchor" href="#scmerge2-batch-correction-as-input-to-metamorph"></a>
</h2>
<p>This is a different approach then before. Here Seurat is not used at
all. Instead we give the raw counts to
<code><a href="../reference/normalize_data.html">metamoRph::normalize_data</a></code> which is used internally by
<code><a href="../reference/run_pca.html">metamoRph::run_pca</a></code> to library and log1p normalize the
counts as required by <a href="https://www.nature.com/articles/s41467-023-39923-2" class="external-link">scMerge2</a>.
We find the top 2000 HVG and feed this matrix into scMerge2 to generate
batch correct counts. We use this batch corrected counts to build our
metamoRph PCA reference, then project/morph the new data on it. We use
the projected/morphed PCA space to make a new UMAP and move labels over,
as we have done earlier.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># metaMorph</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># cpm and log1p norm the data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/normalize_data.html">normalize_data</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span>, <span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span>,</span>
<span>    <span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">meta.data</span>, <span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">meta.data</span>, <span class="va">pancreas.list</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span></span>
<span><span class="co"># identify the top 2000 HVG</span></span>
<span><span class="va">hvg_genes</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/select_HVG.html">select_HVG</a></span><span class="op">(</span><span class="va">dat</span>, ntop <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co"># make corrected expression matrix Note: we turn off the unneeded cosineNorm</span></span>
<span><span class="va">scmerge_correction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/scMerge/man/scMerge2.html" class="external-link">scMerge2</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span><span class="va">hvg_genes</span>, <span class="op">]</span>, batch <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">tech</span>, cosineNorm <span class="op">=</span> <span class="cn">FALSE</span>, cellTypes <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">celltype</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span>, seed <span class="op">=</span> <span class="st">"2023.0723"</span><span class="op">)</span></span>
<span><span class="co"># pull corrected matrix out of the scmerge2 object</span></span>
<span><span class="va">corrected_dat</span> <span class="op">&lt;-</span> <span class="va">scmerge_correction</span><span class="op">$</span><span class="va">newY</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># again we turn off normalization as the scmerge corrected data has already been cpm and log1p</span></span>
<span><span class="co"># normalized</span></span>
<span><span class="va">scmerge2_batch_cor_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 11.555 sec elapsed</span></span>
<span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">reference_obj</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/run_pca.html">run_pca</a></span><span class="op">(</span><span class="va">corrected_dat</span>, meta <span class="op">=</span> <span class="va">meta</span>, method <span class="op">=</span> <span class="st">"irlba"</span>, irlba_n <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    normalization <span class="op">=</span> <span class="cn">FALSE</span>, ntop <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># run umap</span></span>
<span><span class="va">ref_umap_scMerge2</span> <span class="op">&lt;-</span> <span class="fu">uwot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html" class="external-link">umap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>, metric <span class="op">=</span> <span class="st">"cosine"</span>, ret_model <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">metamoRph_ref_with_scmerge2_correct_counts</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6.115 sec elapsed</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu">quick_plotter</span><span class="op">(</span><span class="va">ref_umap_scMerge2</span><span class="op">$</span><span class="va">embedding</span>, <span class="va">reference_obj</span><span class="op">$</span><span class="va">meta</span>, <span class="st">"celltype"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Reference: celseq, celseq2, smartseq2"</span><span class="op">)</span></span>
<span><span class="co"># create projected PCA space with the new data via metamoRph's matrix multplication</span></span>
<span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">query_morphed</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pancreas.query</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span><span class="op">)</span>, <span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,</span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, center_scale <span class="op">=</span> <span class="va">reference_obj</span><span class="op">$</span><span class="va">center_scale</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># build cell type label model</span></span>
<span><span class="va">ml</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/model_build.html">model_build</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">reference_obj</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span><span class="op">)</span>, <span class="va">meta</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span></span>
<span><span class="co"># apply the model</span></span>
<span><span class="va">ma</span> <span class="op">&lt;-</span> <span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">ml</span>, <span class="va">query_morphed</span>, <span class="va">pancreas.query</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scmerge2_metamorph_accuracy</span> <span class="op">&lt;-</span> <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sample_label</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Accuracy:"</span>, <span class="va">scmerge2_metamorph_accuracy</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Accuracy: 0.970219435736677"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"# Correct:"</span>, <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "# Correct: 619"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"# Wrong:"</span>, <span class="va">ma</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">!=</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "# Wrong: 19"</span></span>
<span></span>
<span><span class="co"># project the morphed PCA space of the new data onto the existing PCA we built above</span></span>
<span><span class="va">umap_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap_transform.html" class="external-link">umap_transform</a></span><span class="op">(</span><span class="va">query_morphed</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span>, <span class="va">ref_umap_scMerge2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu">quick_plotter</span><span class="op">(</span><span class="va">umap_proj</span>, <span class="va">pancreas.query</span><span class="op">@</span><span class="va">meta.data</span>, <span class="st">"celltype"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Query: fluidigmc1"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/scMerge2-1.png" alt="plot of chunk scMerge2"><div class="figcaption">plot of chunk scMerge2</div>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metamorph_scmerge2_morph_timing</span> <span class="op">&lt;-</span> <span class="fu">tictoc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 1.005 sec elapsed</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="timings">Timings<a class="anchor" aria-label="anchor" href="#timings"></a>
</h2>
<p>Full Seurat is the slowest approach.</p>
<p>metamoRph IS NOT A BATCH CORRECTION tool and thus there is nothing to
record in the “Batch Correction” category for metamoRph.</p>
<p>Building the reference data in Seurat or metamoRph is about the same
time. The slowest step is identical between the two - the irlba PCA/SVD
dimensionality reduction.</p>
<p>Projecting the new data onto the reference is about 20x faster in
metamoRph compared to Seurat.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batch_correction_timing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">seurat_integration_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">scmerge2_batch_cor_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch_correction_timing</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Seurat"</span>, <span class="st">"scMerge2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">build_reference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">seurat_rebuild_analysis_on_corrected_data_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">metamoRph_build_ref_from_seurat_counts</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">metamoRph_ref_with_scmerge2_correct_counts</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">build_reference</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Seurat"</span>, <span class="st">"metamoRph (Seurat origin)"</span>, <span class="st">"metamoRph (scMerge2 origin)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">projection_timing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">seurat_projection_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">seurat_metamorph_project_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">metamorph_scmerge2_morph_timing</span><span class="op">$</span><span class="va">callback_msg</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">projection_timing</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Seurat"</span>, <span class="st">"metamoRph (Seurat origin)"</span>, <span class="st">"metamoRph (scMerge2 origin)"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">batch_correction_timing</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Step <span class="op">=</span> <span class="st">"Batch Correction"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">batch_correction_timing</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">build_reference</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Step <span class="op">=</span> <span class="st">"Build Reference"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">build_reference</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">projection_timing</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Step <span class="op">=</span> <span class="st">"Query Projection"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">projection_timing</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Method</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Seurat"</span>, <span class="st">"metamoRph*"</span>, <span class="st">"scMerge2"</span>, <span class="st">"metamoRph (Seurat origin)"</span>,</span>
<span>        <span class="st">"metamoRph (scMerge2 origin)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Method</span>, x <span class="op">=</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Step</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time (seconds)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">time</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="st">"inward"</span>, color <span class="op">=</span> <span class="st">"orange"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/batch%20correction%20timings-1.png" alt="plot of chunk batch correction timings"><div class="figcaption">plot of chunk batch correction timings</div>
</div>
</div>
<div class="section level2">
<h2 id="accuracy-of-label-transfer">Accuracy of Label Transfer<a class="anchor" aria-label="anchor" href="#accuracy-of-label-transfer"></a>
</h2>
<p>All three approaches have highly similar accuracy. I guess if you are
getting really nit picky the Seurat counts used in metamoRph are a touch
worse than full Seurat and the scMerge2/Seurat approach is a bit better.
But all work pretty well in my opinion.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accuracy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">seurat_default_accuracy</span>, <span class="va">seurat_metamorph_accuracy</span>, <span class="va">scmerge2_metamorph_accuracy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">accuracy</span><span class="op">$</span><span class="va">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Seurat"</span>, <span class="st">"metamoRph (Seurat origin)"</span>, <span class="st">"metamoRph (scMerge2 origin)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">accuracy</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Accuracy"</span>, <span class="st">"Method"</span><span class="op">)</span></span>
<span><span class="va">accuracy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Accuracy <span class="op">=</span> <span class="va">Accuracy</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Method</span>, x <span class="op">=</span> <span class="va">Accuracy</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Accuracy</span>,</span>
<span>    <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="st">"inward"</span>, color <span class="op">=</span> <span class="st">"orange"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"% Correct Transferred Cell Type Labels"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/batch%20correction%20accuracy-1.png" alt="plot of chunk batch correction accuracy"><div class="figcaption">plot of chunk batch correction accuracy</div>
</div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">#&gt; Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">#&gt; Running under: macOS Ventura 13.4.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib </span></span>
<span><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: America/New_York</span></span>
<span><span class="co">#&gt; tzcode source: internal</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats4    stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt;  [1] tictoc_1.2                  metamoRph_0.2.0             testthat_3.1.8             </span></span>
<span><span class="co">#&gt;  [4] projectR_1.16.0             recount3_1.10.2             SummarizedExperiment_1.30.1</span></span>
<span><span class="co">#&gt;  [7] Biobase_2.60.0              GenomicRanges_1.52.0        GenomeInfoDb_1.36.0        </span></span>
<span><span class="co">#&gt; [10] IRanges_2.34.0              S4Vectors_0.38.1            BiocGenerics_0.46.0        </span></span>
<span><span class="co">#&gt; [13] MatrixGenerics_1.12.0       matrixStats_0.63.0          knitr_1.43                 </span></span>
<span><span class="co">#&gt; [16] scMerge_1.16.0              patchwork_1.1.2             cowplot_1.1.1              </span></span>
<span><span class="co">#&gt; [19] ggplot2_3.4.2               uwot_0.1.14                 Matrix_1.5-4.1             </span></span>
<span><span class="co">#&gt; [22] dplyr_1.1.2                 panc8.SeuratData_3.0.2      SeuratData_0.2.2           </span></span>
<span><span class="co">#&gt; [25] SeuratObject_4.1.3          Seurat_4.3.0.1             </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;   [1] R.methodsS3_1.8.2           dichromat_2.0-0.1           progress_1.2.2             </span></span>
<span><span class="co">#&gt;   [4] urlchecker_1.0.1            nnet_7.3-19                 goftest_1.2-3              </span></span>
<span><span class="co">#&gt;   [7] Biostrings_2.67.2           rstan_2.21.8                vctrs_0.6.2                </span></span>
<span><span class="co">#&gt;  [10] spatstat.random_3.1-5       digest_0.6.31               png_0.1-8                  </span></span>
<span><span class="co">#&gt;  [13] registry_0.5-1              ggrepel_0.9.3               deldir_1.0-9               </span></span>
<span><span class="co">#&gt;  [16] parallelly_1.36.0           batchelor_1.15.1            MASS_7.3-60                </span></span>
<span><span class="co">#&gt;  [19] pkgdown_2.0.7               reshape2_1.4.4              foreach_1.5.2              </span></span>
<span><span class="co">#&gt;  [22] httpuv_1.6.11               withr_2.5.0                 xfun_0.39                  </span></span>
<span><span class="co">#&gt;  [25] ellipsis_0.3.2              survival_3.5-5              commonmark_1.9.0           </span></span>
<span><span class="co">#&gt;  [28] memoise_2.0.1               proxyC_0.3.3                rcmdcheck_1.4.0            </span></span>
<span><span class="co">#&gt;  [31] ggbeeswarm_0.7.2            profvis_0.3.8               zoo_1.8-12                 </span></span>
<span><span class="co">#&gt;  [34] gtools_3.9.4                pbapply_1.7-2               R.oo_1.25.0                </span></span>
<span><span class="co">#&gt;  [37] DEoptimR_1.1-0              Formula_1.2-5               prettyunits_1.1.1          </span></span>
<span><span class="co">#&gt;  [40] KEGGREST_1.39.0             promises_1.2.0.1            httr_1.4.6                 </span></span>
<span><span class="co">#&gt;  [43] restfulr_0.0.15             rhdf5filters_1.12.1         globals_0.16.2             </span></span>
<span><span class="co">#&gt;  [46] fitdistrplus_1.1-11         cvTools_0.3.2               rhdf5_2.44.0               </span></span>
<span><span class="co">#&gt;  [49] ps_1.7.5                    rstudioapi_0.14             miniUI_0.1.1.1             </span></span>
<span><span class="co">#&gt;  [52] generics_0.1.3              ggalluvial_0.12.5           base64enc_0.1-3            </span></span>
<span><span class="co">#&gt;  [55] processx_3.8.1              babelgene_22.9              curl_5.0.0                 </span></span>
<span><span class="co">#&gt;  [58] zlibbioc_1.46.0             sfsmisc_1.1-15              ScaledMatrix_1.8.1         </span></span>
<span><span class="co">#&gt;  [61] polyclip_1.10-4             xopen_1.0.0                 GenomeInfoDbData_1.2.10    </span></span>
<span><span class="co">#&gt;  [64] doParallel_1.0.17           xtable_1.8-4                stringr_1.5.0              </span></span>
<span><span class="co">#&gt;  [67] desc_1.4.2                  evaluate_0.21               S4Arrays_1.0.4             </span></span>
<span><span class="co">#&gt;  [70] BiocFileCache_2.7.2         hms_1.1.3                   irlba_2.3.5.1              </span></span>
<span><span class="co">#&gt;  [73] colorspace_2.1-0            filelock_1.0.2              ROCR_1.0-11                </span></span>
<span><span class="co">#&gt;  [76] CoGAPS_3.19.1               reticulate_1.28             spatstat.data_3.0-1        </span></span>
<span><span class="co">#&gt;  [79] magrittr_2.0.3              lmtest_0.9-40               later_1.3.1                </span></span>
<span><span class="co">#&gt;  [82] viridis_0.6.3               lattice_0.21-8              mapproj_1.2.11             </span></span>
<span><span class="co">#&gt;  [85] NMF_0.26                    spatstat.geom_3.2-2         future.apply_1.11.0        </span></span>
<span><span class="co">#&gt;  [88] robustbase_0.99-0           scattermore_1.1             XML_3.99-0.14              </span></span>
<span><span class="co">#&gt;  [91] scuttle_1.9.4               RcppAnnoy_0.0.20            Hmisc_5.1-0                </span></span>
<span><span class="co">#&gt;  [94] pillar_1.9.0                StanHeaders_2.26.27         nlme_3.1-162               </span></span>
<span><span class="co">#&gt;  [97] iterators_1.0.14            gridBase_0.4-7              caTools_1.18.2             </span></span>
<span><span class="co">#&gt; [100] compiler_4.3.0              beachmat_2.15.0             stringi_1.7.12             </span></span>
<span><span class="co">#&gt; [103] tensor_1.5                  devtools_2.4.5              GenomicAlignments_1.35.1   </span></span>
<span><span class="co">#&gt; [106] plyr_1.8.8                  msigdbr_7.5.1               crayon_1.5.2               </span></span>
<span><span class="co">#&gt; [109] abind_1.4-5                 BiocIO_1.9.2                scater_1.28.0              </span></span>
<span><span class="co">#&gt; [112] locfit_1.5-9.7              pals_1.7                    sp_2.0-0                   </span></span>
<span><span class="co">#&gt; [115] waldo_0.5.1                 bit_4.0.5                   fastmatch_1.1-3            </span></span>
<span><span class="co">#&gt; [118] codetools_0.2-19            BiocSingular_1.15.0         bslib_0.5.0                </span></span>
<span><span class="co">#&gt; [121] plotly_4.10.1               mime_0.12                   splines_4.3.0              </span></span>
<span><span class="co">#&gt; [124] Rcpp_1.0.10                 dbplyr_2.3.2                sparseMatrixStats_1.11.1   </span></span>
<span><span class="co">#&gt; [127] blob_1.2.4                  utf8_1.2.3                  reldist_1.7-2              </span></span>
<span><span class="co">#&gt; [130] fs_1.6.2                    listenv_0.9.0               checkmate_2.2.0            </span></span>
<span><span class="co">#&gt; [133] DelayedMatrixStats_1.21.0   pkgbuild_1.4.0              tibble_3.2.1               </span></span>
<span><span class="co">#&gt; [136] callr_3.7.3                 statmod_1.5.0               tweenr_2.0.2               </span></span>
<span><span class="co">#&gt; [139] startupmsg_0.9.6            pkgconfig_2.0.3             tools_4.3.0                </span></span>
<span><span class="co">#&gt; [142] cachem_1.0.8                RSQLite_2.3.1               viridisLite_0.4.2          </span></span>
<span><span class="co">#&gt; [145] DBI_1.1.3                   numDeriv_2016.8-1.1         fastmap_1.1.1              </span></span>
<span><span class="co">#&gt; [148] rmarkdown_2.21              scales_1.2.1                grid_4.3.0                 </span></span>
<span><span class="co">#&gt; [151] usethis_2.1.6               ica_1.0-3                   Rsamtools_2.15.2           </span></span>
<span><span class="co">#&gt; [154] sass_0.4.6                  BiocManager_1.30.20         RANN_2.6.1                 </span></span>
<span><span class="co">#&gt; [157] rpart_4.1.19                farver_2.1.1                mgcv_1.8-42                </span></span>
<span><span class="co">#&gt; [160] yaml_2.3.7                  roxygen2_7.2.3              foreign_0.8-84             </span></span>
<span><span class="co">#&gt; [163] rtracklayer_1.59.1          cli_3.6.1                   purrr_1.0.1                </span></span>
<span><span class="co">#&gt; [166] leiden_0.4.3                lifecycle_1.0.3             M3Drop_1.26.0              </span></span>
<span><span class="co">#&gt; [169] mvtnorm_1.1-3               bluster_1.9.1               sessioninfo_1.2.2          </span></span>
<span><span class="co">#&gt; [172] backports_1.4.1             BiocParallel_1.33.11        distr_2.9.2                </span></span>
<span><span class="co">#&gt; [175] gtable_0.3.3                rjson_0.2.21                ggridges_0.5.4             </span></span>
<span><span class="co">#&gt; [178] densEstBayes_1.0-2.2        progressr_0.13.0            parallel_4.3.0             </span></span>
<span><span class="co">#&gt; [181] limma_3.56.1                jsonlite_1.8.4              edgeR_3.42.2               </span></span>
<span><span class="co">#&gt; [184] bitops_1.0-7                bit64_4.0.5                 brio_1.1.3                 </span></span>
<span><span class="co">#&gt; [187] Rtsne_0.16                  spatstat.utils_3.0-3        BiocNeighbors_1.17.1       </span></span>
<span><span class="co">#&gt; [190] RcppParallel_5.1.7          bdsmatrix_1.3-6             jquerylib_0.1.4            </span></span>
<span><span class="co">#&gt; [193] highr_0.10                  metapod_1.7.0               dqrng_0.3.0                </span></span>
<span><span class="co">#&gt; [196] loo_2.6.0                   R.utils_2.12.2              lazyeval_0.2.2             </span></span>
<span><span class="co">#&gt; [199] shiny_1.7.4                 ruv_0.9.7.1                 htmltools_0.5.5            </span></span>
<span><span class="co">#&gt; [202] sctransform_0.3.5           rappdirs_0.3.3              formatR_1.14               </span></span>
<span><span class="co">#&gt; [205] glue_1.6.2                  ResidualMatrix_1.10.0       XVector_0.40.0             </span></span>
<span><span class="co">#&gt; [208] RCurl_1.98-1.12             rprojroot_2.0.3             scran_1.27.1               </span></span>
<span><span class="co">#&gt; [211] gridExtra_2.3               igraph_1.4.3                R6_2.5.1                   </span></span>
<span><span class="co">#&gt; [214] tidyr_1.3.0                 SingleCellExperiment_1.22.0 gplots_3.1.3               </span></span>
<span><span class="co">#&gt; [217] forcats_1.0.0               labeling_0.4.2              rngtools_1.5.2             </span></span>
<span><span class="co">#&gt; [220] cluster_2.1.4               bbmle_1.0.25                Rhdf5lib_1.22.0            </span></span>
<span><span class="co">#&gt; [223] pkgload_1.3.2               rstantools_2.3.1            DelayedArray_0.26.6        </span></span>
<span><span class="co">#&gt; [226] tidyselect_1.2.0            vipor_0.4.5                 htmlTable_2.4.1            </span></span>
<span><span class="co">#&gt; [229] maps_3.4.1                  ggforce_0.4.1               xml2_1.3.4                 </span></span>
<span><span class="co">#&gt; [232] inline_0.3.19               AnnotationDbi_1.61.2        future_1.32.0              </span></span>
<span><span class="co">#&gt; [235] rsvd_1.0.5                  munsell_0.5.0               KernSmooth_2.23-21         </span></span>
<span><span class="co">#&gt; [238] data.table_1.14.8           fgsea_1.25.0                htmlwidgets_1.6.2          </span></span>
<span><span class="co">#&gt; [241] RColorBrewer_1.1-3          biomaRt_2.55.0              rlang_1.1.1                </span></span>
<span><span class="co">#&gt; [244] spatstat.sparse_3.0-2       spatstat.explore_3.2-1      remotes_2.4.2              </span></span>
<span><span class="co">#&gt; [247] fansi_1.0.4                 beeswarm_0.4.0</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David McGaughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
