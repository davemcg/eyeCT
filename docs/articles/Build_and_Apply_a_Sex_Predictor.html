<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metamoRph">
<title>Build and Apply a Sex Predictor and Pull Apart the Why • metamoRph</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Build and Apply a Sex Predictor and Pull Apart the Why">
<meta property="og:description" content="metamoRph">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">metamoRph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/So_many_ways_to_screw_up_PCA_projection.html">So many ways to screw up PCA projection</a>
    <a class="dropdown-item" href="../articles/real_data_testing.html">Metadata Label Transfer on Real Data</a>
    <a class="dropdown-item" href="../articles/build_a_brain_region_predictor.html">Build and Apply a Human Brain Region Predictor in 60 seconds or less</a>
    <a class="dropdown-item" href="../articles/Build_and_Apply_a_Sex_Predictor.html">Build and Apply a Sex Predictor and Pull Apart the Why</a>
    <a class="dropdown-item" href="../articles/morph_scRNA_query_onto_reference.html">Transfer Labels from a Retina scRNA Reference onto a Query Dataset</a>
    <a class="dropdown-item" href="../articles/dataset_integration_and_projection.html">Batch Corrected metamoRph Reference</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Build and Apply a Sex Predictor and Pull Apart the Why</h1>
            
            <h4 data-toc-skip class="date">2023-08-29</h4>
      
      
      <div class="d-none name"><code>Build_and_Apply_a_Sex_Predictor.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The GTEx resource contains thousands of human RNA-seq tissues. Here
we use the recount3 package to pull the GTEx brain RNA-seq datasets, use
a subset to build a sex predictor, then apply it to the remaining GTEx
brain data <strong>and</strong> bring in a <em>outside</em> eye studies
to see whether the model still is useful.</p>
</div>
<div class="section level2">
<h2 id="pull-in-gtex-brain-counts-via-recount3">Pull in GTEx brain counts via recount3<a class="anchor" aria-label="anchor" href="#pull-in-gtex-brain-counts-via-recount3"></a>
</h2>
<p>We show the <code>gtex.sex</code> to see the sexes of the brain
samples. <code>1</code> is male and <code>2</code> is female.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/LieberInstitute/recount3" class="external-link">recount3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davemcg.github.io/metamoRph/">metamoRph</a></span><span class="op">)</span></span>
<span><span class="va">human_projects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/recount3/man/available_projects.html" class="external-link">available_projects</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">project_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">human_projects</span>, <span class="va">file_source</span> <span class="op">==</span> <span class="st">"gtex"</span> <span class="op">&amp;</span> <span class="va">project_type</span> <span class="op">==</span> <span class="st">"data_sources"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">project</span> <span class="op">==</span> <span class="st">"BRAIN"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rse_gene_brain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/recount3/man/create_rse.html" class="external-link">create_rse</a></span><span class="op">(</span><span class="va">project_info</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">rse_gene_brain</span><span class="op">)</span><span class="op">$</span><span class="va">gtex.sex</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## .</span></span>
<span><span class="co">##    1    2 </span></span>
<span><span class="co">## 2095  836</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="extract-read-counts">Extract read counts<a class="anchor" aria-label="anchor" href="#extract-read-counts"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">brain_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/recount3/man/compute_read_counts.html" class="external-link">compute_read_counts</a></span><span class="op">(</span><span class="va">rse_gene_brain</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-metadata-table-for-the-train-and-project-data">Build metadata table for the “train” and “project” data<a class="anchor" aria-label="anchor" href="#build-metadata-table-for-the-train-and-project-data"></a>
</h2>
<p>The <code>train</code> data is used to build the PCA object. That PCA
data is used in the model building. The <code>project</code> data is
then morphed/projected onto the PCA space with <code>metamoRph</code>
and the output from that is used by <code>model_apply</code> to guess
the sex.</p>
<p>This all happens in less than 10 seconds on my MacBook.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20230824</span><span class="op">)</span></span>
<span><span class="va">brain_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">rse_gene_brain</span><span class="op">)</span></span>
<span><span class="co"># More human readable labels for the Sex</span></span>
<span><span class="va">brain_meta</span><span class="op">$</span><span class="va">Sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">rse_gene_brain</span><span class="op">)</span><span class="op">$</span><span class="va">gtex.sex</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Male"</span>, <span class="st">"Female"</span><span class="op">)</span></span>
<span><span class="va">train_meta</span> <span class="op">&lt;-</span> <span class="va">brain_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span></span>
<span><span class="va">project_meta</span> <span class="op">&lt;-</span> <span class="va">brain_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">train_meta</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co"># remove .digit ending to make a bit more portable across different references</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">brain_counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\.\\d+"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">brain_counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_counts</span> <span class="op">&lt;-</span> <span class="va">brain_counts</span><span class="op">[</span>, <span class="va">train_meta</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span><span class="va">project_counts</span> <span class="op">&lt;-</span> <span class="va">brain_counts</span><span class="op">[</span>, <span class="va">project_meta</span><span class="op">$</span><span class="va">id</span><span class="op">]</span></span>
<span></span>
<span><span class="va">gtex_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_pca.html">run_pca</a></span><span class="op">(</span><span class="va">train_counts</span>, <span class="va">train_meta</span>, irlba_n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sex_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_build.html">model_build</a></span><span class="op">(</span><span class="va">gtex_sex</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span>, <span class="va">gtex_sex</span><span class="op">$</span><span class="va">meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span>, num_PCs <span class="op">=</span> <span class="fl">20</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">projected_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="va">project_counts</span>, <span class="va">gtex_sex</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>, <span class="va">gtex_sex</span><span class="op">$</span><span class="va">center_scale</span><span class="op">)</span></span>
<span><span class="co"># apply model</span></span>
<span><span class="va">label_guesses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">sex_model</span>, <span class="va">projected_data</span>, <span class="va">project_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="accuracy">Accuracy<a class="anchor" aria-label="anchor" href="#accuracy"></a>
</h2>
<p>100%</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_correct</span> <span class="op">&lt;-</span> <span class="va">label_guesses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">num_wrong</span> <span class="op">&lt;-</span> <span class="va">label_guesses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">!=</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># accuracy</span></span>
<span><span class="va">num_correct</span><span class="op">/</span><span class="op">(</span><span class="va">num_correct</span> <span class="op">+</span> <span class="va">num_wrong</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="identify-the-two-most-useful-pc-for-sex">Identify the two most useful PC for Sex<a class="anchor" aria-label="anchor" href="#identify-the-two-most-useful-pc-for-sex"></a>
</h2>
<p>Both models rely most on PC7 and PC8</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sex_model</span><span class="op">$</span><span class="va">Male</span><span class="op">$</span><span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 5 × 2</span></span>
<span><span class="co">##   name          value</span></span>
<span><span class="co">##   &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)  0.5   </span></span>
<span><span class="co">## 2 PC7         -0.0955</span></span>
<span><span class="co">## 3 PC8         -0.0676</span></span>
<span><span class="co">## 4 PC6          0.0347</span></span>
<span><span class="co">## 5 PC16         0.0337</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sex_model</span><span class="op">$</span><span class="va">Female</span><span class="op">$</span><span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 5 × 2</span></span>
<span><span class="co">##   name          value</span></span>
<span><span class="co">##   &lt;chr&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)  0.500 </span></span>
<span><span class="co">## 2 PC7          0.0955</span></span>
<span><span class="co">## 3 PC8          0.0676</span></span>
<span><span class="co">## 4 PC6         -0.0347</span></span>
<span><span class="co">## 5 PC16        -0.0337</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="identify-top-genes-for-pc7">Identify top genes for PC7<a class="anchor" aria-label="anchor" href="#identify-top-genes-for-pc7"></a>
</h2>
<p>As recount3 used the “ENGS” identifier, we have to pull the gene IDs
from another source. In this case, <code>org.Hs.eg.db</code>.</p>
<p>We show the genes that contribute most to each PC (both top and
bottom five).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rotation</span> <span class="op">&lt;-</span> <span class="va">gtex_sex</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC7"</span>, <span class="st">"PC8"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"ENSEMBL"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">org.Hs.eg.db</span><span class="op">)</span></span>
<span><span class="va">conv_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/AnnotationDb-class.html" class="external-link">select</a></span><span class="op">(</span><span class="va">org.Hs.eg.db</span>, keys <span class="op">=</span> <span class="va">rotation</span><span class="op">$</span><span class="va">ENSEMBL</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SYMBOL"</span>, <span class="st">"GENENAME"</span>, <span class="st">"MAP"</span>,</span>
<span>    <span class="st">"GENETYPE"</span><span class="op">)</span>, keytype <span class="op">=</span> <span class="st">"ENSEMBL"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rotation</span> <span class="op">&lt;-</span> <span class="va">rotation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">conv_table</span>, by <span class="op">=</span> <span class="st">"ENSEMBL"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">rotation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">PC7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, <span class="va">rotation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">PC7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">PC7</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 10 × 7</span></span>
<span><span class="co">##    ENSEMBL             PC7     PC8 SYMBOL  GENENAME                                 MAP      GENETYPE      </span></span>
<span><span class="co">##    &lt;chr&gt;             &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;                                    &lt;chr&gt;    &lt;chr&gt;         </span></span>
<span><span class="co">##  1 ENSG00000114374 -0.195  -0.138  USP9Y   ubiquitin specific peptidase 9 Y-linked  Yq11.221 protein-coding</span></span>
<span><span class="co">##  2 ENSG00000114374 -0.195  -0.138  TTTY15  testis-specific transcript, Y-linked 15  Yq11.221 ncRNA         </span></span>
<span><span class="co">##  3 ENSG00000067048 -0.191  -0.141  DDX3Y   DEAD-box helicase 3 Y-linked             Yq11.221 protein-coding</span></span>
<span><span class="co">##  4 ENSG00000131002 -0.191  -0.137  &lt;NA&gt;    &lt;NA&gt;                                     &lt;NA&gt;     &lt;NA&gt;          </span></span>
<span><span class="co">##  5 ENSG00000012817 -0.188  -0.137  KDM5D   lysine demethylase 5D                    Yq11.223 protein-coding</span></span>
<span><span class="co">##  6 ENSG00000270641  0.181   0.127  TSIX    TSIX transcript, XIST antisense RNA      Xq13.2   ncRNA         </span></span>
<span><span class="co">##  7 ENSG00000229807  0.181   0.126  XIST    X inactive specific transcript           Xq13.2   ncRNA         </span></span>
<span><span class="co">##  8 ENSG00000274655  0.167   0.132  &lt;NA&gt;    &lt;NA&gt;                                     &lt;NA&gt;     &lt;NA&gt;          </span></span>
<span><span class="co">##  9 ENSG00000120738  0.0957 -0.0459 EGR1    early growth response 1                  5q31.2   protein-coding</span></span>
<span><span class="co">## 10 ENSG00000180828  0.0853 -0.0247 BHLHE22 basic helix-loop-helix family member e22 8q12.3   protein-coding</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="visualize-the-rotations">Visualize the rotations<a class="anchor" aria-label="anchor" href="#visualize-the-rotations"></a>
</h2>
<p>We see how the chrY genes are pointing towards the male samples and
vice versa for the chrX genes.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_rotations</span> <span class="op">&lt;-</span> <span class="va">rotation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SYMBOL</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USP9Y"</span>, <span class="st">"TTTY15"</span>, <span class="st">"TSIX"</span>, <span class="st">"XIST"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rotation_multipler_first</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">rotation_multipler_second</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">projected_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">rse_gene_brain</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">label_guesses</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"sample_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Sex <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">gtex.sex</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"Male"</span>, <span class="va">gtex.sex</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"Female"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC7</span>, y <span class="op">=</span> <span class="va">PC8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">top_rotations</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span>, xend <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="st">"PC7"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="va">rotation_multipler_first</span>, yend <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="st">"PC8"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>        <span class="va">rotation_multipler_second</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_label_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">top_rotations</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="st">"PC7"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span></span>
<span>    <span class="va">rotation_multipler_first</span>, y <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="st">"PC8"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="va">rotation_multipler_second</span>, label <span class="op">=</span> <span class="va">GENENAME</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="float">
<img src="figure/sex_rotations-1.png" alt="plot of chunk sex_rotations"><div class="figcaption">plot of chunk sex_rotations</div>
</div>
</div>
<div class="section level2">
<h2 id="does-the-model-work-on-outside-data">Does the model work on outside data?<a class="anchor" aria-label="anchor" href="#does-the-model-work-on-outside-data"></a>
</h2>
<p>EiaD data, filtered to the sex-labelled <em>eye</em> data alone (as
EiaD also contains some GTEx)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># outside brain prefrontal cortex (BA9)</span></span>
<span><span class="va">eiad_counts</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"https://hpc.nih.gov/~mcgaugheyd/eyeIntegration/2023/gene_counts.csv.gz"</span><span class="op">)</span></span>
<span><span class="va">eiad_matrix</span> <span class="op">&lt;-</span> <span class="va">eiad_counts</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">eiad_counts</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">eiad_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">eiad_counts</span><span class="op">$</span><span class="va">Gene</span>, <span class="st">"ENSG\\d+"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># eiad metadata</span></span>
<span><span class="va">emeta</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="st">"https://hpc.nih.gov/~mcgaugheyd/eyeIntegration/2023/eyeIntegration23_meta_2023_08_28.csv.gz"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eiad_mat_sexed</span> <span class="op">&lt;-</span> <span class="va">eiad_matrix</span><span class="op">[</span>, <span class="op">(</span><span class="va">emeta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Cohort</span> <span class="op">==</span> <span class="st">"Eye"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">sample_accession</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Run <code>metamoRph</code> to transform the EiaD data into the same
PCA space we made earlier with the GTEx brain data. Then use
<code>model_apply</code> to predict the sex.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projected_data_outside</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="va">eiad_mat_sexed</span>, <span class="va">gtex_sex</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>, <span class="va">gtex_sex</span><span class="op">$</span><span class="va">center_scale</span><span class="op">)</span></span>
<span><span class="va">label_guesses_outside</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">sex_model</span>, <span class="va">projected_data_outside</span>, <span class="va">emeta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Cohort</span> <span class="op">==</span> <span class="st">"Eye"</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">Sex</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="accuracy-1">Accuracy<a class="anchor" aria-label="anchor" href="#accuracy-1"></a>
</h3>
<p>99.5% Three out of 619 labelled sexes are wrong. The three that don’t
match the label have pretty high scores (0.77 to 0.94).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_correct</span> <span class="op">&lt;-</span> <span class="va">label_guesses_outside</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">==</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">num_wrong</span> <span class="op">&lt;-</span> <span class="va">label_guesses_outside</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">!=</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># accuracy</span></span>
<span><span class="va">num_correct</span><span class="op">/</span><span class="op">(</span><span class="va">num_correct</span> <span class="op">+</span> <span class="va">num_wrong</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 99.51768</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">label_guesses_outside</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sample_label</span> <span class="op">!=</span> <span class="va">predict</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">predict_second</span>, <span class="op">-</span><span class="va">predict_stringent</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 3 × 4</span></span>
<span><span class="co">##   sample_id   sample_label predict max_score</span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 DRS161828   Female       Male        0.867</span></span>
<span><span class="co">## 2 DRS161832   Female       Male        0.938</span></span>
<span><span class="co">## 3 SRS11824523 Female       Male        0.772</span></span></code></pre>
<div class="section level4">
<h4 id="labels-wrong">Labels wrong?<a class="anchor" aria-label="anchor" href="#labels-wrong"></a>
</h4>
<p>I’m a bit more suspicious that the labels themselves are wrong. The
first three samples are labelled as females but the ML thinks they are
male. The fourth sample is a female both in ML and label. The fifth
sample is male in both label and ML. We can see the large difference in
CPM of the chrY gene USP9Y which suggest these three are
mislabelled.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">metamoRph</span><span class="fu">::</span><span class="fu"><a href="../reference/normalize_data.html">normalize_data</a></span><span class="op">(</span><span class="va">eiad_matrix</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ENSG00000114374"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DRS161828"</span>, <span class="st">"DRS161832"</span>, <span class="st">"SRS11824523"</span>,</span>
<span>    <span class="st">"DRS161830"</span>, <span class="st">"DRS161829"</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span>rownames <span class="op">=</span> <span class="st">"sample_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">label_guesses_outside</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">sample_id</span><span class="op">:</span><span class="va">predict</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## # A tibble: 5 × 4</span></span>
<span><span class="co">##   sample_id   ENSG00000114374 sample_label predict</span></span>
<span><span class="co">##   &lt;chr&gt;                 &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;  </span></span>
<span><span class="co">## 1 DRS161828             3.73  Female       Male   </span></span>
<span><span class="co">## 2 DRS161832             4.15  Female       Male   </span></span>
<span><span class="co">## 3 SRS11824523           3.73  Female       Male   </span></span>
<span><span class="co">## 4 DRS161830             0.228 Female       Female </span></span>
<span><span class="co">## 5 DRS161829             4.12  Male         Male</span></span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="save-for-future-use">Save for future use<a class="anchor" aria-label="anchor" href="#save-for-future-use"></a>
</h2>
<p>This is admittedly a bit rough, as I have not re-used existing models
in anger much.</p>
<p>There are (up to) two “things” to save:</p>
<ol style="list-style-type: decimal">
<li>The PCA info (<code>gtex_sex</code>). You only <em>need</em> the
rotation matrix (<code>gtex_sex$PCA$rotation</code>) and the
center/scale values (<code>gtex_sex$center_scale</code>). The matrix and
center/scale values can be saved as text files. But it is much easier to
just <code>save</code> the object itself, which also has the full
<code>prcomp</code> object and the metadata. Then you can
<code>load</code> it later. But if you need to pare it down for
“production” use, then go ahead and just save the rotation matrix and
center/scale values however you prefer.</li>
<li>The trained model (<code>sex_model</code>). I suggest you just
save/load via <code>save</code> and <code>load</code>. You can trim the
<a href="https://win-vector.com/2014/05/30/trimming-the-fat-from-glm-models-in-r/" class="external-link">fat</a>,
if you are building a huge model.</li>
</ol>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"mkdir -p ~/data/metamoRph_models/"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">gtex_sex</span>, <span class="va">sex_model</span>, file <span class="op">=</span> <span class="st">"~/data/metamoRph_models/sex.Rdata"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Ventura 13.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] knitr_1.43                  org.Hs.eg.db_3.17.0         AnnotationDbi_1.61.2        metamoRph_0.2.0            </span></span>
<span><span class="co">##  [5] recount3_1.10.2             SummarizedExperiment_1.30.2 Biobase_2.60.0              GenomicRanges_1.52.0       </span></span>
<span><span class="co">##  [9] GenomeInfoDb_1.36.1         IRanges_2.34.1              S4Vectors_0.38.1            BiocGenerics_0.46.0        </span></span>
<span><span class="co">## [13] MatrixGenerics_1.12.3       matrixStats_1.0.0           dplyr_1.1.2                 ggplot2_3.4.2              </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] rstudioapi_0.14             magrittr_2.0.3              farver_2.1.1                rmarkdown_2.23             </span></span>
<span><span class="co">##   [5] fs_1.6.3                    BiocIO_1.9.2                zlibbioc_1.46.0             vctrs_0.6.3                </span></span>
<span><span class="co">##   [9] memoise_2.0.1               Rsamtools_2.15.2            DelayedMatrixStats_1.21.0   RCurl_1.98-1.12            </span></span>
<span><span class="co">##  [13] htmltools_0.5.5             S4Arrays_1.0.5              curl_5.0.0                  BiocNeighbors_1.17.1       </span></span>
<span><span class="co">##  [17] tictoc_1.2                  desc_1.4.2                  cachem_1.0.8                GenomicAlignments_1.35.1   </span></span>
<span><span class="co">##  [21] igraph_1.4.3                lifecycle_1.0.3             pkgconfig_2.0.3             rsvd_1.0.5                 </span></span>
<span><span class="co">##  [25] Matrix_1.5-4.1              R6_2.5.1                    fastmap_1.1.1               GenomeInfoDbData_1.2.10    </span></span>
<span><span class="co">##  [29] digest_0.6.33               colorspace_2.1-0            ps_1.7.5                    rprojroot_2.0.3            </span></span>
<span><span class="co">##  [33] dqrng_0.3.0                 irlba_2.3.5.1               RSQLite_2.3.1               beachmat_2.15.0            </span></span>
<span><span class="co">##  [37] filelock_1.0.2              labeling_0.4.2              fansi_1.0.4                 httr_1.4.6                 </span></span>
<span><span class="co">##  [41] abind_1.4-5                 compiler_4.3.0              bit64_4.0.5                 withr_2.5.0                </span></span>
<span><span class="co">##  [45] BiocParallel_1.33.11        DBI_1.1.3                   highr_0.10                  R.utils_2.12.2             </span></span>
<span><span class="co">##  [49] maps_3.4.1                  DelayedArray_0.26.7         sessioninfo_1.2.2           rjson_0.2.21               </span></span>
<span><span class="co">##  [53] bluster_1.9.1               tools_4.3.0                 R.oo_1.25.0                 glue_1.6.2                 </span></span>
<span><span class="co">##  [57] callr_3.7.3                 restfulr_0.0.15             grid_4.3.0                  cluster_2.1.4              </span></span>
<span><span class="co">##  [61] generics_0.1.3              gtable_0.3.3                R.methodsS3_1.8.2           tidyr_1.3.0                </span></span>
<span><span class="co">##  [65] data.table_1.14.8           BiocSingular_1.15.0         ScaledMatrix_1.8.1          metapod_1.7.0              </span></span>
<span><span class="co">##  [69] utf8_1.2.3                  XVector_0.40.0              ggrepel_0.9.3               pillar_1.9.0               </span></span>
<span><span class="co">##  [73] stringr_1.5.0               limma_3.56.1                pals_1.7                    BiocFileCache_2.7.2        </span></span>
<span><span class="co">##  [77] lattice_0.21-8              rtracklayer_1.59.1          bit_4.0.5                   tidyselect_1.2.0           </span></span>
<span><span class="co">##  [81] SingleCellExperiment_1.22.0 locfit_1.5-9.7              Biostrings_2.67.2           scuttle_1.9.4              </span></span>
<span><span class="co">##  [85] edgeR_3.42.2                xfun_0.40                   statmod_1.5.0               stringi_1.7.12             </span></span>
<span><span class="co">##  [89] yaml_2.3.7                  evaluate_0.21               codetools_0.2-19            tibble_3.2.1               </span></span>
<span><span class="co">##  [93] cli_3.6.1                   processx_3.8.1              munsell_0.5.0               dichromat_2.0-0.1          </span></span>
<span><span class="co">##  [97] Rcpp_1.0.11                 mapproj_1.2.11              dbplyr_2.3.2                png_0.1-8                  </span></span>
<span><span class="co">## [101] XML_3.99-0.14               parallel_4.3.0              pkgdown_2.0.7               blob_1.2.4                 </span></span>
<span><span class="co">## [105] scran_1.27.1                sparseMatrixStats_1.11.1    bitops_1.0-7                scales_1.2.1               </span></span>
<span><span class="co">## [109] purrr_1.0.1                 crayon_1.5.2                rlang_1.1.1                 cowplot_1.1.1              </span></span>
<span><span class="co">## [113] KEGGREST_1.39.0             formatR_1.14</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David McGaughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
